import logging
import pgdb as DB2
from datetime import date, datetime, timedelta

class dbconfig:
    database        =       'framecea'        # Database to connect to. Please use an empty database for best results.
    user            =       'postgres'      # User ID to connect with
    password        =       'db2011'      # Password for given User ID
    hostname        =       'localhost'     # Hostname
    port            =       5432           # Port Number

class dbinterface:
    
    __idalarm = 0
    __idurlnext = 0

    def __init__(self, dbconfig, logging, dblock):
        self.dbconfig = dbconfig
        self.log = logging
        self.dblock = dblock
        try:
        	self.conn = DB2.connect ( '127.0.0.1:framecea:postgres:db2011')
        	#self.conn = DB2.connect (dsn = self.dbconfig.database, user = self.dbconfig.user, password = self.dbconfig.password, host = self.dbconfig.hostname )
        except:
		print("Connexion failed: toto")
        self.cpt = 0
            
    def newIdSession(self):
        request = "SELECT MAX(idsession) FROM session"
        insertLine = "INSERT INTO session(samplename,ostype) VALUES(' ',' ')"
        
        cursor = self.conn.cursor()
        
        self.dblock.acquire()
            
        cursor.execute(insertLine)
        
        cursor.execute(request.encode("utf-8","replace"))
        
        row = cursor.fetchone()
        sessionMax = row[0]
        
        #self.log.debug("Session Max ID: "+str(sessionMax))
        
        self.conn.commit()
        
        self.dblock.release()
        
        cursor.close()
        
        return sessionMax
            
            
    #(id bigint NOT NULL, idsession integer, tstamp TIMESTAMP, type varchar(256), return integer, pid int, ppid int, scontext varchar(256), nameSubject CLOB(10K), nameObject CLOB(10K), tcontext varchar(256), perms varchar(256), data CLOB(1M), FOREIGN KEY(idsession) REFERENCES session(idsession))"
    def insert(self, id, idsession, ts, type, ret, pid, ppid, scontext, nameSubject, nameObject, tcontext, perms, data):
        tsp = datetime(1601, 1, 1) + timedelta(microseconds=int(ts)/10)
        request = "INSERT INTO trace(id,idsession,tstamp,type,return,pid,ppid,scontext,nameSubject,nameObject,tcontext,perms,data) VALUES("+str(id)+","
        request = request+str(idsession)+",'"
        request = request+str(DB2.Timestamp(tsp.year, tsp.month, tsp.day, tsp.hour, tsp.minute, tsp.second))+"','"
        request = request+str(type)+"','"+str(ret)+"',"+str(pid)+","+str(ppid)+",'"
        request = request+scontext.replace("'","''")+"','"
        request = request+nameSubject.replace("'","''").replace("\\","/")+"','"
        request = request+nameObject.replace("'","''").replace("\\","/") +"','"
        request = request+tcontext.replace("'","''")+"','"
        request = request+perms+"','"
        request = request+data.replace("'","''")+"')"
        #self.log.debug("InsertLine: "+request)
        cursor = self.conn.cursor()
        try:
            request = request.decode("unicode","replace")
        except:
            try:
                request = request.encode('ascii', 'xmlcharrefreplace')
                #request.encode("utf8")
            except:
                request = "%s" % request
        request = request.encode("utf8")
            #except:
             #   print("Error encoding UTF8")
        cursor.execute(request)

        self.conn.commit()
	print request
       # if self.cpt == 1:
        #    self.conn.commit()
        #    self.conn.commit()
         #   self.cpt = 0
        #else:
         #   self.cpt = self.cpt + 1        
        
        # self.conn.commit()
        cursor.close()
        return 1
    
    def insertNet(self, id, idsession, ts, type, ret, pid, ppid, scontext, nameSubject, ipsource, portsource, ipdest, portdest, state, typeconnect, netsize, proto, data):
        try:
            tsp = datetime(1601, 1, 1) + timedelta(microseconds=int(ts)/10)
            request = "INSERT INTO tracenet(id,idsession,tstamp,type,return,pid,ppid,scontext,nameSubject,ipSource,PortSource,ipDest,PortDest,state,typeconnect,netsize,proto,data) VALUES("+str(id)+","
            request = request+str(idsession)+",'"
            request = request+DB2.Timestamp(tsp.year, tsp.month, tsp.day, tsp.hour, tsp.minute, tsp.second)+"','"
            request = request+str(type)+"','"+str(ret)+"',"+str(pid)+","+str(ppid)+",'"
            request = request+scontext.replace("'","''")+"','"
            request = request+nameSubject.replace("'","''").replace("\\","/")+"','"
            request = request+ipsource+"',"+portsource+",'"
            request = request+ipdest+"',"+portdest+",'"
            request = request+state+"','"+typeconnect+"',"+netsize+",'"+proto+"','"
            request = request+data.replace("'","''")+"')"
        except:
            self.log.debug("db2interface:insertNet:"+request)
            return
        #self.log.debug("InsertLine: "+request)
        cursor = self.conn.cursor()
        try:
            request = request.decode("unicode","replace")
        except:
            try:
                request = request.encode('ascii', 'xmlcharrefreplace')
                #request.encode("utf8")
            except:
                request = "%s" % request
        try:
            try:
                request = request.encode("utf8")
            except:
                print("Error encoding UTF8")
            cursor.execute(request)
        except:
            print("Error DB2: "+request)
            request = request.encode('ascii', 'xmlcharrefreplace')
            try:
                 cursor.execute(request)
            except:
                print("Error DB2 ASCII: "+request)

        if self.cpt == 1000:
            self.conn.commit()
            self.cpt = 0
        else:
            self.cpt = self.cpt + 1        
        
        # self.conn.commit()
        cursor.close()
        return 1
    
