#include "driver.h"

VOID FonctionDeLaMortQuiTueQuiFaitDesBSODEtQueMemeLesLinuxiensNePeuventPasFaireParceQuIlsSontJaloux()
{
	PVOID plop=NULL;
	
	ExFreePool(plop);
	
}

NTSTATUS NewNtCreateSection(
	OUT PHANDLE SectionHandle, 
	IN ULONG DesiredAccess, 
	IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL, 
	IN PLARGE_INTEGER MaximumSize OPTIONAL, 
	IN ULONG PageAttributess, 
	IN ULONG SectionAttributes, 
	IN HANDLE FileHandle OPTIONAL )
{
	ProcessInformationFile				process;
    NTSTATUS							rc = 0, ntStatus;
	PFILE_OBJECT 						fileObject = NULL;
	ANSI_STRING 						ansi_cible ;
	ULONG 								retLen;
    UNICODE_STRING        				*path_str = NULL;
	PPUBLIC_OBJECT_TYPE_INFORMATION 	publicobj;
	int 								i, j,taille, bool=0;
	char 								temp[500];
	char 								object_context[600];
	char 								securitycontext[225];

	rc = ( (NTCREATESECTION)(*OldNtCreateSection) ) (
		SectionHandle, 
		DesiredAccess, 
		ObjectAttributes, 
		MaximumSize, 
		PageAttributess, 
		SectionAttributes, 
		FileHandle);
		
	process = GetProcessInfoFile();
	RtlZeroMemory(&securitycontext, sizeof(securitycontext));
	GetSecurityContextSubject(process, securitycontext);
	
	if((PageAttributess & PAGE_EXECUTE ))  
	{
		if(FileHandle != NULL)
		{
			ObReferenceObjectByHandle(FileHandle, 0, 0, KernelMode, &fileObject, NULL);

			if (fileObject)
			{
				ntStatus = ObQueryNameString(fileObject, (POBJECT_NAME_INFORMATION)path_str, 0, &retLen);
				path_str = (PUNICODE_STRING)ExAllocatePoolWithTag(NonPagedPool, retLen, 0);
				if (ntStatus == STATUS_INFO_LENGTH_MISMATCH)
				{
					if (path_str)
					{
						ntStatus = ObQueryNameString(fileObject, (POBJECT_NAME_INFORMATION)path_str, retLen, &retLen);
						
						if(!NT_SUCCESS(ntStatus))
							return rc;
					}
					else
						return rc;
				}
			
				RtlUnicodeStringToAnsiString(&ansi_cible,  path_str, TRUE);
	
				RtlZeroMemory(&temp, sizeof(temp));
				RtlZeroMemory(&object_context, sizeof(object_context));
				
				// Chargement d'un executable
				if(_stricmp(&ansi_cible.Buffer[strlen(ansi_cible.Buffer)-strlen(".exe")], ".exe") == 0 )
				{
					TransformToContext(ansi_cible, temp);
					sprintf(object_context,"system_u:object_r:%s_exec_t", temp);
					bool=1;
				}
				
				if(_stricmp(&ansi_cible.Buffer[strlen(ansi_cible.Buffer)-strlen(".tmp")], ".tmp") == 0 )
				{
					TransformToContext(ansi_cible, temp);
					sprintf(object_context,"system_u:object_r:%s_tmp_t", temp);
					bool=1;
				}
				
				// Chargement d'une DLL
				if(_stricmp(&ansi_cible.Buffer[strlen(ansi_cible.Buffer)-strlen(".dll")], ".dll") == 0 )
				{
					
					TransformToContext(ansi_cible, temp);
					sprintf(object_context,"system_u:object_r:%s_lib_t", temp);
					bool=1;
				}
				
	
				// Chargement d'un driver
				if(_stricmp(&ansi_cible.Buffer[strlen(ansi_cible.Buffer)-strlen(".sys")], ".sys") == 0 )
				{
					TransformToContext(ansi_cible, temp);
					sprintf(object_context,"system_u:object_r:%s_driver_t", temp);
					bool=1;
				}
				if( bool == 0 )
				{
					TransformToContext(ansi_cible, temp);
					sprintf(object_context,"system_u:object_r:%s_execution_t", temp);
					bool=1;
				}
				if(bool ==1)
				{
					WriteInLog("execute ", process.pid, process.pathname, process.ppid, ansi_cible.Buffer, securitycontext, object_context, "load", rc,0);
				}
				
				if(fileObject)
					ObDereferenceObject(fileObject);
				if (path_str)	
					ExFreePoolWithTag(path_str, 0);
				RtlFreeAnsiString(&ansi_cible);

			}
		}
	}
	
	return rc;

}

void TransformToContext(ANSI_STRING ansi, char * context)
{
	int taille, i=0, j=0;
		
	taille = strlen(ansi.Buffer);
	i=taille;
	
	while(i>0)
	{
		if(ansi.Buffer[i] == '\\')
			break;
		i--;
	}
	i++;
	j=0;
	while(i<taille)
	{
		if(ansi.Buffer[i] == '.')
			break;
		context[j] = ansi.Buffer[i];
		j++;i++;
	}


}


NTSTATUS NewNtOpenProcess(
  __out     PHANDLE ProcessHandle,
  __in      ACCESS_MASK DesiredAccess,
  __in      POBJECT_ATTRIBUTES ObjectAttributes,
  __in_opt  PCLIENT_ID ClientId
)
{
	NTSTATUS ntStatus;
	if( ClientId->UniqueProcess == UserLandID)
		ntStatus = STATUS_ACCESS_DENIED;	
	else
	{
		ntStatus = ((NTOPENPROCESS)(OldNtOpenProcess))(
					ProcessHandle,
					DesiredAccess,
					ObjectAttributes,
					ClientId);
	}
					
	return ntStatus;
}

NTSTATUS  NewNtTerminateProcess(
  __in_opt  HANDLE ProcessHandle,
  __in      NTSTATUS ExitStatus
)
{
	NTSTATUS ntStatus;
	if(ProcessHandle == UserLandID)
		ntStatus = STATUS_ACCESS_DENIED;	
	else
	{
		ntStatus = ((NTTERMINATEPROCESS)(OldNtTerminateProcess))(
					ProcessHandle,
					ExitStatus);
	}
	return ntStatus;
}